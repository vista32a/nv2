# 07 StoryWeaver富文本编辑器功能实现对照表 - Textual移植版

**日期**: 2025-06-02 (初版) | 2025-06-07 (0607功能更新)
**整理**: 让·基尔希斯坦 (AI 项目经理) + 韩吉·佐耶 (创新功能设计师)
**范围**: 🔴核心必需 + 🟡重要推荐 + 🟢有用补充 + 🟣司令专属 + 🟤韩吉创新 + ⚪可选扩展
**技术分析**: 基于Textual库实现方法的QTextEdit移植方案

## 📅 更新记录

### 2025-06-07 (0607功能更新)
**更新者**: 韩吉·佐耶 (模块化编程与系统构建专家)

**新增完成功能** (9项):
- ✅ **034 格式刷** - 完整的FormatPainter类实现，超越基础方案
- ✅ **035 上标/下标** - toggle_superscript/subscript方法，UI完整集成
- ✅ **039 智能缩进** - SmartIndentManager类，智能对话和段落识别
- ✅ **040 字符间距调整** - LetterSpacingDialog对话框，支持多种间距类型
- ✅ **056 右键上下文菜单** - 智能上下文检测，动态菜单生成
- ✅ **059 预览模式** - PreviewMode类，中文友好字体设置
- ✅ **061 表格插入** - TableInsertDialog对话框，自动刷新显示
- ✅ **066 图片插入** - 支持多种格式，QTextImageFormat实现
- ✅ **068 超链接插入** - HyperlinkDialog对话框，支持内外部链接

**技术突破**:
- 🔧 **QTextEdit渲染局限性解决** - 发现并解决了原生渲染vs HTML渲染的差异问题
- 🔧 **自动刷新显示机制** - 实现了强制HTML渲染，解决边框显示问题
- 🔧 **字体大小保存Bug修复** - 通过HTML增强样式彻底解决字体缩小问题

---

## 🔴 核心必需功能详细描述 (P0) - 32项

### 基础文本编辑功能 (7项)

| 序号 | 功能名称 | 具体描述 | Textual实现方法 | QTextEdit移植方案 | 可行性 | 已实现 | 实现一致性与评估 |
|-----|---------|---------|----------------|------------------|:--------:|:---:|:---|
| 001 | **文本输入/删除** | 支持中英文、标点符号、特殊字符的输入和删除操作 | `TextArea._on_key()` 处理键盘事件，`insert()` 和 `delete()` 方法处理文本修改，支持IME输入法 | QTextEdit原生支持，`keyPressEvent()` 处理键盘输入，`insertPlainText()` 插入文本 | ✅ 100% | ✅ 是 | 一致。功能由QTextEdit原生提供。 |
| 002 | **光标移动和定位** | 鼠标点击定位、键盘方向键移动、快捷键跳转（词首词尾、行首行尾、文档首尾） | `Selection` 类管理光标位置，`move_cursor()` 方法，`action_cursor_*()` 系列方法处理各种移动 | QTextCursor系统，`moveCursor()` 方法，支持各种移动模式 | ✅ 100% | ✅ 是 | 一致。功能由QTextEdit原生提供。 |
| 003 | **文本选择** | 单击定位、双击选词、三击选行、拖拽选择、Shift+方向键扩展选择 | `Selection` 类，鼠标事件处理 `_on_mouse_*()` 方法，选择状态管理 | QTextCursor选择API，`setSelection()` 方法，鼠标事件处理 | ✅ 100% | ✅ 是 | 一致。功能由QTextEdit原生提供。 |
| 004 | **🔵复制/剪切/粘贴** | 标准剪贴板操作，支持纯文本和富文本格式 | `action_copy/cut/paste()` 方法，`app.clipboard` 剪贴板集成 | QClipboard集成，`copy()`, `cut()`, `paste()` 方法，支持富文本格式 | ✅ 100% | ✅ 是 | 一致。已连接到`editor.copy/cut/paste`。 |
| 005 | **🔵撤销/重做** | 多级撤销重做，支持至少50步操作历史 | `EditHistory` 类管理操作历史，`undo()` 和 `redo()` 方法，支持50步历史 | QUndoStack集成，`undo()`, `redo()` 方法，可配置历史步数 | ✅ 100% | ✅ 是 | 一致。已连接到`editor.undo/redo`。 |
| 006 | **🔵查找/替换** | 文本搜索、正则表达式搜索、批量替换、大小写敏感选项 | 基础实现，需要自定义搜索逻辑 | QTextDocument::find() 方法，支持正则表达式和各种搜索选项 | ✅ 100% | ✅ 是 | ➕ 不完全一致。当前实现基于`QTextDocument::find()`，但`replace_all`方法额外使用独立光标处理，修复了"替换内容包含查找内容"时可能导致的无限循环bug，比文档中提到的基础方案更健壮。 |
| 007 | **全选功能** | Ctrl+A全选文档内容 | `select_all()` 方法，`action_select_all()` 快捷键绑定 | `selectAll()` 方法，快捷键自动绑定 | ✅ 100% | ✅ 是 | 一致。已连接到`editor.selectAll`。 |

### 字符格式功能 (6项)

| 序号 | 功能名称 | 具体描述 | Textual实现方法 | QTextEdit移植方案 | 可行性 | 已实现 | 实现一致性与评估 |
|-----|---------|---------|----------------|------------------|:--------:|:---:|:---|
| 008 | **粗体/斜体/下划线** | 文字加粗、倾斜、下划线效果，支持组合使用 | `Style` 类的 `bold`, `italic`, `underline` 属性，`stylize()` 方法应用样式 | QTextCharFormat设置字体样式，`setFontWeight()`, `setFontItalic()`, `setUnderlineStyle()` | ✅ 100% | ✅ 是 | 一致。通过`toggle_bold/italic/underline`方法和`QTextCharFormat`实现。 |
| 009 | **字体选择** | 提供常用字体列表：宋体、黑体、楷体、微软雅黑等 | 主题系统中的字体配置，CSS样式控制 | QFont + QFontDatabase，`setFontFamily()` 方法，字体枚举和选择 | ✅ 100% | ✅ 是 | 一致。通过`QFontDialog`实现。 |
| 010 | **字号调整** | 支持8-72号字体，提供常用字号快选 | CSS样式中的字体大小设置 | QTextCharFormat::setFontPointSize()，支持任意字号设置 | ✅ 100% | ✅ 是 | 一致。通过`QFontDialog`实现。 |
| 011 | **文字颜色** | RGB颜色选择器，常用颜色快选，支持十六进制输入 | `Color` 类，`Style.foreground` 属性，支持RGB和十六进制 | QTextCharFormat::setForeground()，QColor支持多种颜色格式 | ✅ 100% | ✅ 是 | 一致。通过`QColorDialog`实现。 |
| 012 | **删除线** | 文字中间横线效果，用于标记删除内容 | `Style.strike` 属性，CSS text-decoration | QTextCharFormat::setStrikeOut()，原生支持删除线 | ✅ 100% | ✅ 是 | 一致。通过`toggle_strike`方法实现。 |
| 013 | **格式化粘贴** | 粘贴时选择保持格式或仅保留文本 | 部分支持，需要自定义剪贴板处理 | QMimeData处理，`insertFromMimeData()` 重写，支持格式选择对话框 | ⚠️ 90% | ✅ 是 (部分) | ➖ 不一致。当前只实现了`paste_as_plain_text` ("粘贴为纯文本")的单向功能，未实现方案中更复杂的"选择保持格式或仅保留文本"的完整逻辑，功能不完整。 |

### 段落格式功能 (8项)

| 序号 | 功能名称 | 具体描述 | Textual实现方法 | QTextEdit移植方案 | 可行性 | 已实现 | 实现一致性与评估 |
|-----|---------|---------|----------------|------------------|:--------:|:---:|:---|
| 014 | **段落对齐** | 左对齐、居中、右对齐、两端对齐四种模式 | `Content._wrap_and_format()` 中的 `align` 参数，CSS text-align | QTextBlockFormat::setAlignment()，支持Qt::AlignLeft/Center/Right/Justify | ✅ 100% | ✅ 是 | 一致。通过`set_alignment`方法和`QTextBlockFormat`实现。 |
| 015 | **首行缩进** | 段落首行缩进2字符，符合中文排版习惯 | CSS text-indent 样式控制 | QTextBlockFormat::setTextIndent()，支持像素和字符单位 | ✅ 100% | ✅ 是 | 一致。通过`toggle_first_line_indent`方法实现。 |
| 016 | **段落缩进** | 整段左右缩进，用于引用、特殊内容标记 | CSS margin 控制，样式系统支持 | QTextBlockFormat::setIndent()，setLeftMargin()，setRightMargin() | ✅ 100% | ✅ 是 | 一致。通过`increase_indent`和`decrease_indent`方法实现。 |
| 017 | **行距调整** | 单倍、1.15倍、1.5倍、2倍行距，自定义数值 | CSS line-height 样式，`_wrap_and_format()` 处理 | QTextBlockFormat::setLineHeight()，支持固定值和比例值 | ✅ 100% | ✅ 是 | 一致。通过`set_line_spacing`方法和菜单选项实现。 |
| 018 | **段前段后间距** | 段落间距控制，用于章节、场景分隔 | CSS margin-top/bottom 样式 | QTextBlockFormat::setTopMargin()，setBottomMargin() | ✅ 100% | ✅ 于0606实现 | 一致。通过`ParagraphSpacingDialog`类和`set_paragraph_spacing`方法实现，包含完整的对话框UI和段落间距应用逻辑。 |
| 019 | **有序列表** | 数字、字母、罗马数字编号列表 | 基础支持，需要自定义列表渲染 | QTextList + QTextListFormat，支持多种编号样式 | ✅ 95% | ✅ 是 | 一致。通过`insert_numbered_list`实现，但仅支持默认数字样式。 |
| 020 | **无序列表** | 圆点、方块、空心圆等符号列表 | 基础支持，需要自定义符号渲染 | QTextList + QTextListFormat，支持多种符号样式 | ✅ 95% | ✅ 是 | 一致。通过`insert_bullet_list`实现，但仅支持默认圆点样式。 |
| 021 | **多级列表** | 支持3-5级嵌套列表，自动缩进和编号 | 有限支持，需要复杂的嵌套逻辑 | QTextList嵌套，QTextListFormat层级管理，需要自定义嵌套逻辑 | ⚠️ 85% | ➖ 于0606部分实现 | 部分一致。通过`increase_indent`和`decrease_indent`方法实现逻辑层级关系，但存在视觉样式串扰和规则不透明问题，需要进一步改进样式切换规则。 |

### 文档结构功能 (6项)

| 序号 | 功能名称 | 具体描述 | Textual实现方法 | QTextEdit移植方案 | 可行性 | 已实现 | 实现一致性与评估 |
|-----|---------|---------|----------------|------------------|:--------:|:---:|:---|
| 022 | **标题样式(H1-H6)** | 6级标题层次，不同字号和样式，用于章节结构 | Markdown渲染中的 `HEADINGS` 字典，`MarkdownH1-H6` 类 | QTextCharFormat + 样式管理器，预定义6级标题样式 | ✅ 95% | ✅ 于0606实现 | 一致。通过`set_heading_style`方法实现6级标题样式，包含字体大小映射(H1:22pt, H2:18pt, H3:15pt, H4:13pt, H5:12pt, H6:11pt)和加粗设置，UI菜单完整集成。 |
| 023 | **样式库管理** | 预定义样式集：正文、标题、引用、注释等 | `TextAreaTheme` 主题系统，样式映射 | 自定义样式管理器，QTextCharFormat/BlockFormat模板库 | ✅ 90% | ✅ 于0606实现 | 一致。通过`apply_quote_style`和`apply_code_block_style`方法实现预设样式库，包含引用样式(灰色背景+斜体)和代码块样式(等宽字体+背景色)，UI菜单集成。 |
| 024 | **分页符/分节符** | 强制分页，章节分隔，打印排版控制 | 有限支持，主要用于终端显示 | QTextFrameFormat，QTextDocument分页支持，需要自定义分页逻辑 | ⚠️ 80% | ✅ 于0606实现 | 一致。通过`insert_page_break`方法实现，使用QTextFrameFormat设置分页策略，并插入可视化水平线作为用户界面表示。 |
| 025 | **目录自动生成** | 基于标题层次自动生成可点击目录 | Markdown的 `TableOfContentsType` 支持 | 文档结构分析，QTextCursor遍历，自动生成目录树 | ⚠️ 85% | ✅ 于0606实现 | 一致。通过`generate_toc`方法实现，包含文档结构分析、TOC框架管理、可点击链接生成和导航功能，支持标题层次缩进显示。 |
| 026 | **书签/锚点** | 文档内快速定位标记，便于跳转 | 基础支持，位置记录 | QTextCursor + 位置管理器，书签数据库，快速跳转API | ✅ 90% | ✅ 于0606实现 | 一致。通过目录生成功能实现，包含锚点创建(`setAnchorHref`)和导航(`navigate_to_anchor`)，支持点击跳转到文档指定位置，核心书签功能已具备。 |
| 027 | **章节管理** | 章节折叠展开，大纲视图，章节重排 | 有限支持，主要是显示层面 | 需要自定义实现，QTextDocument结构分析，折叠状态管理 | ⚠️ 80% | ❌ 否 | 未实现。 |

### 界面交互功能 (5项)

| 序号 | 功能名称 | 具体描述 | Textual实现方法 | QTextEdit移植方案 | 可行性 | 已实现 | 实现一致性与评估 |
|-----|---------|---------|----------------|------------------|:--------:|:---:|:---|
| 028 | **工具栏** | 常用功能图标按钮：保存、撤销、格式等 | `Horizontal` 布局 + `Button` 组件，工具栏容器 | QToolBar + QAction，图标和工具提示支持 | ✅ 100% | ✅ 是 | 一致。通过`_setup_toolbar`实现。 |
| 029 | **菜单系统** | 完整功能菜单：文件、编辑、格式、视图等 | `App` 类的菜单系统，键盘绑定 | QMenuBar + QMenu，层级菜单和快捷键自动显示 | ✅ 100% | ✅ 是 | 一致。通过`_setup_menus`实现。 |
| 030 | **状态栏** | 显示字数、页数、光标位置、选择状态等信息 | `Footer` 组件，`Label` 显示状态信息 | QStatusBar + QLabel，实时更新机制 | ✅ 100% | ✅ 是 | 一致。可显示字数和光标位置。 |
| 031 | **所见即所得** | 编辑时直接显示最终排版效果 | `TextArea` 实时渲染，样式即时应用 | QTextEdit原生支持，富文本实时渲染 | ✅ 100% | ✅ 是 | 一致。QTextEdit原生即为所见即所得。 |
| 032 | **格式状态显示** | 当前光标位置的格式信息显示 | 光标位置样式检测，状态追踪 | `currentCharFormat()` 获取当前格式，信号槽更新UI | ✅ 100% | ✅ 是 | 一致。通过`update_format_actions`方法更新工具栏和菜单中Action的状态。 |

---

## 🟡 重要推荐功能详细描述 (P1) - 28项

### 高级编辑功能 (8项)

| 序号 | 功能名称 | 具体描述 | Textual实现方法 | QTextEdit移植方案 | 可行性 | 已实现 | 实现一致性与评估 |
|-----|---------|---------|----------------|------------------|:--------:|:---:|:---|
| 033 | **文字背景色/高亮** | 文字背景颜色，用于标记重要内容、伏笔等 | `Style.background` 属性，`stylize()` 方法应用背景色 | QTextCharFormat::setBackground()，QColor支持 | ✅ 100% | ✅ 于0606实现 | 一致。通过`select_highlight_color`方法实现，使用QColorDialog选择背景颜色并应用到选区或光标位置。 |
| 034 | **格式刷** | 复制一处格式并应用到其他文本 | 样式复制机制，需要自定义实现 | 格式复制+应用机制，QTextCharFormat复制和应用 | ✅ 95% | ✅ 于0607实现 | ➕ 超越一致。实现了完整的FormatPainter类，包含格式复制、应用、取消功能，支持光标样式切换和状态管理，比基础方案更完善。 |
| 035 | **上标/下标** | 文字上标下标效果，用于注释、特殊符号 | CSS vertical-align 样式控制 | QTextCharFormat::setVerticalAlignment()，支持上标下标 | ✅ 100% | ✅ 于0607实现 | 一致。通过toggle_superscript和toggle_subscript方法实现，支持QTextCharFormat::AlignSuperScript和AlignSubScript，UI菜单和工具栏完整集成。 |
| 036 | **引用格式** | 块引用和行内引用样式，用于引用其他作品 | 块样式，缩进和特殊标记 | QTextBlockFormat + 自定义样式，缩进和边框 | ✅ 90% | ✅ 于0606实现 | 一致。通过`apply_quote_style`方法实现，包含灰色背景(#f0f0f0)、左右边距(20px)、斜体字符格式和深灰色文字(#555555)。 |
| 037 | **代码格式** | 等宽字体代码块，用于特殊文本标记 | 等宽字体样式，背景色设置 | 等宽字体 + 背景色，QTextCharFormat设置 | ✅ 95% | ✅ 于0606实现 | 一致。通过`apply_code_block_style`方法实现，包含Consolas等宽字体(11pt)、灰色背景(#e9e9e9)、边距设置和深灰色文字(#333333)。 |
| 038 | **🔵🟤智能节点链接与自动完成** | 人名、地名等常用词汇的输入建议，智能提示可能关联的现有节点，支持模糊搜索和别名识别，一键插入节点链接 | 无直接支持，需要自定义自动完成 | 自定义实现 + QCompleter，模糊搜索算法，节点数据库 | ⚠️ 85% | ❌ 否 | 未实现。 |
| 039 | **智能缩进** | 对话、段落的自动缩进调整 | 基础支持，上下文分析有限 | 上下文分析 + 自动调整，QTextBlockFormat缩进设置 | ✅ 90% | ✅ 于0607实现 | ➕ 超越一致。实现了SmartIndentManager类，包含对话行检测、段落开始判断、自动缩进应用，支持对话缩进和段落首行缩进的智能识别，比基础方案更智能。 |
| 040 | **字符间距调整** | 字符和词语间距的精细控制 | CSS letter-spacing 样式 | QFont::setLetterSpacing()，支持字符间距调整 | ✅ 100% | ✅ 于0607实现 | ➕ 超越一致。实现了LetterSpacingDialog对话框和set_letter_spacing方法，支持百分比和绝对值两种间距类型，提供完整的UI交互，比基础方案更用户友好。 |

### 文档管理功能 (7项)

| 序号 | 功能名称 | 具体描述 | Textual实现方法 | QTextEdit移植方案 | 可行性 | 已实现 | 实现一致性与评估 |
|-----|---------|---------|----------------|------------------|:--------:|:---:|:---|
| 041 | **新建/打开/保存** | 基础文件操作，支持多种格式 | 基础文件操作，`load_text()` 和 `save()` 方法 | QFileDialog + 文件操作，支持多种格式 | ✅ 100% | ✅ 是 | 一致。实现了`new/open/save/save_as`，支持HTML和TXT。 |
| 042 | **🔵自动保存** | 定时自动保存，防止意外丢失 | 无直接支持，需要定时器实现 | QTimer + 增量保存，状态提示 | ✅ 100% | ❌ 否 | 未实现。 |
| 043 | **🟤一键多格式导出与发布预设** | 导出为PDF、EPUB、DOCX、HTML等格式，内置主流发布平台排版预设和元数据填写辅助 | 无直接支持，需要外部转换库 | 格式转换库集成，QPrinter支持PDF，需要第三方库 | ⚠️ 90% | ❌ 否 | 未实现。 |
| 044 | **文档模板** | 预设小说模板：现代、古风、科幻等 | 无直接支持，需要模板系统 | 模板系统，QTextDocument模板加载 | ✅ 95% | ❌ 否 | 未实现。 |
| 045 | **🔵标签页切换** | 多章节同时编辑，标签页管理 | 无直接支持，需要多窗口管理 | QTabWidget，多文档管理 | ✅ 100% | ❌ 否 | 未实现，当前为单文档界面。 |
| 046 | **🔵会话恢复** | 软件重启后恢复上次编辑状态 | 无直接支持，需要状态持久化 | 状态序列化，QSettings保存恢复 | ✅ 95% | ❌ 否 | 未实现。 |
| 047 | **🔵自动备份** | 定期创建备份文件，多版本保存 | 无直接支持，需要版本管理 | 版本管理，文件备份策略 | ✅ 95% | ❌ 否 | 未实现。 |

### 编辑辅助功能 (6项)

| 序号 | 功能名称 | 具体描述 | Textual实现方法 | QTextEdit移植方案 | 可行性 | 已实现 | 实现一致性与评估 |
|-----|---------|---------|----------------|------------------|:--------:|:---:|:---|
| 048 | **拼写检查** | 实时检测错别字，提供修改建议 | 无直接支持，需要外部词典库 | QTextDocument + 词典库，自定义拼写检查器 | ⚠️ 85% | ❌ 否 | 未实现。 |
| 049 | **语法检查** | 基础语法错误检测和提示 | 无直接支持，需要语法规则引擎 | 语法规则引擎，自定义语法检查器 | ⚠️ 80% | ❌ 否 | 未实现。 |
| 050 | **自动格式化** | 自动调整段落格式、标点符号等 | 基础支持，样式系统可扩展 | 格式规则 + 批量处理，QTextDocument操作 | ✅ 90% | ❌ 否 | 未实现。 |
| 051 | **样式快速应用** | 快捷键或按钮快速应用预设样式 | 样式系统，键盘绑定支持 | 快捷键 + 样式绑定，QShortcut + QTextCharFormat | ✅ 95% | ✅ 于0606实现 | 一致。通过格式菜单中的样式库子菜单和工具栏按钮实现引用、代码块样式的快速应用，支持一键应用预设样式。 |
| 052 | **🔵🟤思维导图式大纲编辑器** | 显示文档结构树，支持导航和编辑，提供思维导图式的大纲编辑工具，大纲与正文双向同步 | 无直接支持，需要自定义树形控件 | 自定义树形控件，QTreeWidget + 双向同步机制 | ⚠️ 75% | ❌ 否 | 未实现。 |
| 053 | **🔵交叉引用** | 人物、地点、情节的关联引用管理 | 无直接支持，需要引用数据库 | 引用数据库 + 链接管理，QTextCursor跳转 | ⚠️ 80% | ❌ 否 | 未实现。 |

### 界面扩展功能 (4项)

| 序号 | 功能名称 | 具体描述 | Textual实现方法 | QTextEdit移植方案 | 可行性 | 已实现 | 实现一致性与评估 |
|-----|---------|---------|----------------|------------------|:--------:|:---:|:---|
| 054 | **格式工具栏** | 专门的富文本格式化工具栏 | 工具栏系统，按钮组件 | QToolBar专门化，格式按钮和状态同步 | ✅ 100% | ✅ 是 | 一致。格式化按钮已集成在主工具栏中。 |
| 055 | **格式菜单** | 完整的格式选项菜单 | 菜单系统，分级结构 | QMenu专门化，格式选项和预览 | ✅ 100% | ✅ 是 | 一致。已在菜单栏创建"格式"菜单。 |
| 056 | **右键上下文菜单** | 根据选择内容显示相关操作 | 上下文菜单支持 | QMenu + 上下文检测，动态菜单生成 | ✅ 100% | ✅ 于0607实现 | ➕ 超越一致。实现了智能上下文菜单，根据选择内容动态显示相关操作（格式、样式、段落、插入等），包含格式刷状态检测和列表状态判断，比基础方案更智能。 |
| 057 | **🔵侧边栏** | 大纲、角色、设定等辅助信息面板 | 面板系统，停靠支持 | QDockWidget，可停靠面板系统 | ✅ 100% | ❌ 否 | 未实现。 |

### 视图模式功能 (3项)

| 序号 | 功能名称 | 具体描述 | Textual实现方法 | QTextEdit移植方案 | 可行性 | 已实现 | 实现一致性与评估 |
|-----|---------|---------|----------------|------------------|:--------:|:---:|:---|
| 058 | **🟤零干扰全屏专注模式Pro Max** | 隐藏界面元素，专注写作环境，支持自定义打字机音效、光标样式、纸张背景纹理，分屏显示参考资料 | 无直接支持，需要自定义全屏模式 | 全屏模式 + UI隐藏，音效系统，自定义渲染 | ✅ 95% | ❌ 否 | 未实现。 |
| 059 | **预览模式** | 只读模式查看最终排版效果 | 渲染系统，只读模式 | 只读模式 + 渲染优化，打印预览 | ✅ 95% | ✅ 于0607实现 | ➕ 超越一致。实现了PreviewMode类，包含进入/退出预览模式、样式切换、光标隐藏，支持中文友好字体设置和F5快捷键切换，比基础方案更完善。 |
| 060 | **源码视图** | 显示底层标记代码，高级编辑 | 无直接支持，需要代码编辑器 | HTML/Markdown显示，代码编辑器集成 | ✅ 90% | ❌ 否 | 未实现。 |

---

## 🟢 有用补充功能详细描述 (P2) - 18项

### 表格功能 (5项)

| 序号 | 功能名称 | 具体描述 | Textual实现方法 | QTextEdit移植方案 | 可行性 | 已实现 | 实现一致性与评估 |
|-----|---------|---------|----------------|------------------|:--------:|:---:|:---|
| 061 | **表格插入** | 创建指定行列数的表格 | `DataTable` 组件，基础表格支持 | QTextTable，表格创建和管理 | ✅ 90% | ✅ 于0607实现 | ➕ 超越一致。实现了TableInsertDialog对话框和insert_table方法，支持自定义行列数、边框样式设置、示例内容填充，包含自动刷新显示机制解决边框显示问题，比基础方案更完善。 |
| 062 | **表格编辑** | 增删行列，调整表格结构 | `DataTable` 编辑功能 | QTextTable操作API，行列增删 | ⚠️ 85% | ❌ 否 | 未实现。 |
| 063 | **单元格合并/拆分** | 合并相邻单元格，拆分已合并单元格 | 无直接支持，需要自定义实现 | QTextTable::mergeCells()，单元格合并拆分 | ⚠️ 80% | ❌ 否 | 未实现。 |
| 064 | **表格样式** | 边框样式、背景色、对齐方式设置 | CSS样式系统，表格样式 | QTextTableFormat，边框和样式设置 | ✅ 90% | ❌ 否 | 未实现。 |
| 065 | **表格对齐** | 表格在页面中的对齐位置 | 布局系统，对齐控制 | QTextFrameFormat，表格对齐设置 | ⚠️ 85% | ❌ 否 | 未实现。 |

### 媒体插入功能 (3项)

| 序号 | 功能名称 | 具体描述 | Textual实现方法 | QTextEdit移植方案 | 可行性 | 已实现 | 实现一致性与评估 |
|-----|---------|---------|----------------|------------------|:--------:|:---:|:---|
| 066 | **图片插入** | 插入本地图片文件，支持常见格式 | 无直接支持，需要图像处理 | QTextImageFormat，图片插入和显示 | ✅ 95% | ✅ 于0607实现 | 一致。通过insert_image方法实现，支持png、jpg、jpeg、gif、bmp、svg格式，使用QFileDialog选择文件，QTextImageFormat插入显示，默认宽度400px。 |
| 067 | **图片调整** | 调整图片大小、位置、对齐方式 | 无直接支持，需要图像操作 | QTextImageFormat属性，大小和位置调整 | ✅ 90% | ❌ 否 | 未实现。 |
| 068 | **超链接插入** | 创建指向网址或文档内位置的链接 | 链接支持，`Link` 类 | QTextCharFormat::setAnchor()，超链接创建 | ✅ 95% | ✅ 于0607实现 | ➕ 超越一致。实现了HyperlinkDialog对话框和insert_hyperlink方法，支持显示文本和链接地址设置，包含点击跳转功能（内部锚点和外部网址），比基础方案更完整。 |

### 页面设置功能 (4项)

| 序号 | 功能名称 | 具体描述 | Textual实现方法 | QTextEdit移植方案 | 可行性 | 已实现 | 实现一致性与评估 |
|-----|---------|---------|----------------|------------------|:--------:|:---:|:---|
| 069 | **页边距设置** | 设置页面上下左右边距 | 无直接支持，主要用于终端显示 | QTextDocument::setDocumentMargin()，页边距设置 | ✅ 95% | ❌ 否 | 未实现。 |
| 070 | **纸张大小** | A4、A5、自定义等纸张尺寸选择 | 无直接支持，终端无纸张概念 | QPrinter + 页面设置，纸张大小选择 | ✅ 90% | ❌ 否 | 未实现。 |
| 071 | **页面方向** | 纵向或横向页面布局 | 无直接支持，终端无方向概念 | QPrinter::setOrientation()，页面方向设置 | ✅ 90% | ❌ 否 | 未实现。 |
| 072 | **分栏布局** | 单栏、双栏、三栏等分栏排版 | 无直接支持，需要自定义布局 | QTextFrameFormat分栏，需要自定义分栏逻辑 | ⚠️ 80% | ❌ 否 | 未实现。 |

### 个性化设置功能 (6项)

| 序号 | 功能名称 | 具体描述 | Textual实现方法 | QTextEdit移植方案 | 可行性 | 已实现 | 实现一致性与评估 |
|-----|---------|---------|----------------|------------------|:--------:|:---:|:---|
| 073 | **字体配置** | 设置编辑器默认字体和大小 | 字体系统，主题配置 | QFont配置，字体选择和设置 | ✅ 100% | ❌ 否 | 未实现。 |
| 074 | **🔵快捷键自定义** | 自定义常用功能的快捷键组合 | 键盘绑定系统，`Binding` 类 | QShortcut + 配置系统，快捷键管理 | ✅ 100% | ❌ 否 | 未实现，快捷键均为硬编码。 |
| 075 | **🔵工具栏自定义** | 调整工具栏按钮布局和显示 | 工具栏系统，布局管理 | QToolBar自定义，按钮布局管理 | ✅ 100% | ❌ 否 | 未实现，工具栏内容和布局均为硬编码。 |
| 076 | **🔵界面布局** | 调整面板位置和大小 | 布局系统，面板管理 | QSplitter + 布局保存，停靠窗口管理 | ✅ 100% | ❌ 否 | 未实现。 |
| 077 | **标尺显示** | 显示页面标尺，辅助排版 | 无直接支持，需要自定义控件 | 自定义标尺控件，QWidget绘制 | ⚠️ 85% | ❌ 否 | 未实现。 |
| 078 | **浮动面板** | 可移动的格式化工具面板 | 面板系统，浮动支持 | QDockWidget浮动，可移动面板 | ✅ 95% | ❌ 否 | 未实现。 |

## 功能实现优先级建议

1. **第一阶段**: 🔴核心必需功能 (32项) - 基础可用版本
2. **第二阶段**: 🟡重要推荐功能 (28项) - 完整功能版本  
3. **第三阶段**: 🟢有用补充功能 (18项) - 专业增强版本

**总计**: 78项通用功能 + 15项司令专属功能 = 93项完整功能

---

## 🟣 司令专属功能 (来自Novel Universe Frame规范19 + 韩吉高优先级创新) - 23项

### 框架集成核心功能 (6项)

| 序号 | 功能名称 | 具体描述 | 实现要点 |
|-----|---------|---------|---------|
| 079 | **🟣 多文档状态管理** | 支持多个文档同时编辑，独立状态管理 | document_id标识，状态隔离，内存管理 |
| 080 | **🟣🟤 节点语义实时感知与动态样式** | 基于节点映射的差异化样式显示，实时感知当前光标所在文本对应的BaseNode类型，动态应用语义化样式 | 节点映射维护，语义分析器，动态样式应用，实时感知算法<br/>**🟤韩吉创新**: 实时光标位置节点感知，动态样式切换，用户自定义语义样式 |
| 081 | **🟣 结构化编辑指令应用** | 接收并应用来自AI的结构化编辑命令 | 指令解析，精确定位，智能应用，结果反馈 |
| 082 | **🟣 实时事件信号发射** | 向框架发送文本变更、光标移动等事件信号 | 信号系统，事件封装，异步通知 |
| 083 | **🟣 AST语法解析集成** | 基于py-tree-sitter的语法解析和查询 | 增量解析，AST维护，节点查询API |
| 084 | **🟣 差异比较与报告** | 基于DeepDiff的文本变更检测和报告生成 | 差异算法，报告格式化，可视化支持 |

### 高级编辑核心 (5项)

| 序号 | 功能名称 | 具体描述 | 实现要点 |
|-----|---------|---------|---------|
| 085 | **🟣 智能定位与匹配** | 结合行号、模糊匹配、AST节点的精确文本定位 | Levenshtein算法，AST查询，多重定位策略 |
| 086 | **🟣 增量语法高亮** | 基于AST的高效增量语法高亮更新 | tree.edit()机制，局部重绘，性能优化 |
| 087 | **🟣 上下文感知编辑** | 根据光标位置和AST节点提供上下文相关的编辑功能 | 节点类型识别，上下文分析，智能建议 |
| 088 | **🟣 编辑状态追踪** | 详细追踪编辑操作，支持精确的撤销重做 | 操作记录，状态快照，增量更新 |
| 089 | **🟣 语言文法动态加载** | 支持多种语言文法的动态加载和切换 | 文法管理，动态解析器，语言识别 |

### API接口层 (5项)

| 序号 | 功能名称 | 具体描述 | 实现要点 |
|-----|---------|---------|---------|
| 090 | **🟣 内容加载与获取API** | load_content, get_current_text, get_selected_text等 | API设计，参数验证，状态同步 |
| 091 | **🟣 光标与选择API** | get_cursor_position, selection_changed等位置管理 | 坐标系统，选择范围，事件处理 |
| 092 | **🟣 语法查询API** | get_ast_node_at_cursor, get_highlighting_info等 | AST遍历，节点信息封装，查询优化 |
| 093 | **🟣 编辑应用API** | apply_user_edit, apply_structured_ai_edits等 | 编辑验证，冲突处理，结果报告 |
| 094 | **🟣 AI视觉化创作辅助** | 支持用AI生成概念图、设计稿或分镜，基于文本描述生成视觉化素材辅助创作 | AI图像生成接口，文本到图像转换，素材管理，嵌入支持 |

### 韩吉高优先级AI创新功能 (7项)

| 序号 | 功能名称 | 具体描述 | 实现要点 |
|-----|---------|---------|---------|
| 095 | **🟤 世界观碎片自动捕获与节点创建建议** | 编辑器后台分析文本，识别新的世界观设定、角色名、地点等碎片信息，智能提示创建新BaseNode | 文本分析算法，实体识别，节点创建建议，预填充信息<br/>**🟤韩吉创新**: 与LLM集成服务配合，智能识别世界观要素，自动节点创建建议 |
| 096 | **🟤 灵感火花AI助手** | 内置可随时唤出的AI助手，提供剧情发展建议、角色行为推演、对话风格模拟、场景氛围描写增强等 | AI对话界面，上下文理解，多维度创作辅助，实时建议生成<br/>**🟤韩吉创新**: 基于LIS的全方位创作辅助，充分发挥AI潜力 |
| 097 | **🟤 结构化编辑智能应用** | 用户可用自然语言下达复杂编辑指令，编辑器通过LIS和CodexWeaver精确执行 | 自然语言理解，指令解析，精确定位执行，结果反馈<br/>**🟤韩吉创新**: 自然语言编辑指令，智能理解与执行 |
| 098 | **🟤 多版本剧情线AI推演与管理** | 对关键剧情节点创建多个假设分支，AI基于世界观和角色设定推演不同分支，提供可视化管理界面 | 分支管理，AI推演算法，可视化界面，版本比较<br/>**🟤韩吉创新**: 多线叙事支持，AI辅助剧情推演，分支可视化管理 |
| 099 | **🟤 动态情境编辑器主题与氛围** | 编辑器主题根据当前编辑场景类型或特定节点动态切换，增强写作代入感 | 主题切换引擎，场景识别，氛围渲染，背景音乐集成<br/>**🟤韩吉创新**: 沉浸式写作体验，动态主题切换，情境感知 |
| 100 | **🟤 可编程写作仪式感模块** | 允许用户定义写作仪式，如开始写作前播放音乐、达到字数后鼓励动画、完成章节后庆祝动作等 | 脚本引擎，事件触发，动画系统，音效管理<br/>**🟤韩吉创新**: 个性化写作体验，习惯培养，激励机制 |
| 101 | **🟤 卡片式素材与笔记管理系统** | 类似Trello的卡片式管理系统，收集灵感、角色小传、物品设定等，可自由拖拽、打标签、嵌入正文 | 卡片管理界面，拖拽系统，标签分类，正文嵌入<br/>**🟤韩吉创新**: 碎片化信息管理，卡片式界面，灵活组织 |

---

## ⚪ 可选扩展功能 (韩吉低优先级创新) - 3项

### 多维度内容组织与展现扩展 (1项)

| 序号 | 功能名称 | 具体描述 | 实现要点 |
|-----|---------|---------|---------|
| 102 | **⚪ 版本时光机与写作热力图** | 结合VersionControlService提供直观的版本对比界面，时光倒流式查看历史版本，根据编辑频率生成写作热力图 | 版本可视化，时间轴界面，热力图算法，编辑统计分析<br/>**⚪韩吉扩展**: 超越简单diff的版本对比，写作习惯分析，创作瓶颈识别 |

### 协同与发布扩展 (2项)

| 序号 | 功能名称 | 具体描述 | 实现要点 |
|-----|---------|---------|---------|
| 103 | **⚪ 云端同步与幽灵协作者模式** | 支持整个小说宇宙框架项目安全云端同步，提供幽灵协作者模式，允许授权编辑以只读或建议模式查看评论 | 云端服务，数据加密，权限管理，协作界面，建议模式<br/>**⚪韩吉扩展**: 多设备同步，非侵入式协作，精细权限控制 |
| 104 | **⚪ 一键发布平台集成** | 在多格式导出基础上，进一步集成主流发布平台API，实现真正的一键发布到各大平台 | 平台API集成，发布流程自动化，状态跟踪，发布历史管理<br/>**⚪韩吉扩展**: 平台深度集成，发布流程优化，多平台统一管理 |

---

## 功能统计总结

- **🔴 核心必需功能**: 32项 (其中🔵框架集成4项，🟤韩吉创新0项)
- **🟡 重要推荐功能**: 28项 (其中🔵框架集成7项，🟤韩吉创新3项)
- **🟢 有用补充功能**: 18项 (其中🔵框架集成3项，🟤韩吉创新1项)
- **🟣 司令专属功能**: 23项 (Novel Universe Frame规范19深度集成16项 + 韩吉🟤创新7项)
- **⚪ 可选扩展功能**: 3项 (韩吉低优先级创新)

**总计**: 104项完整功能
- **基础功能**: 78项通用功能
- **框架集成**: 14项🔵 + 16项🟣 = 30项
- **韩吉创新**: 15项 (🟤标记12项 + ⚪低优先级3项)

**实施优先级**:
1. **第一阶段**: 🔴核心必需功能 (32项)
2. **第二阶段**: 🟡重要推荐功能 (28项) + 🟣司令专属功能 (23项)
3. **第三阶段**: 🟢有用补充功能 (18项)
4. **第四阶段**: ⚪可选扩展功能 (3项)

---

## 📊 Textual移植技术分析总结

### 🎯 总体可行性评估

经过对78项通用功能的逐一技术分析，移植可行性统计如下：

#### **按可行性分级**:
- ✅ **完全可行 (95-100%)**: **62项** (79.5%)
- ⚠️ **需要开发 (80-94%)**: **16项** (20.5%)
- ❌ **困难实现 (<80%)**: **0项** (0%)

#### **按优先级分级**:
- 🔴 **核心必需功能**: 32项，平均可行性 **95.6%**
- 🟡 **重要推荐功能**: 28项，平均可行性 **92.5%**
- 🟢 **有用补充功能**: 18项，平均可行性 **90.8%**

### 📈 **总体结论**: **93.2%高度可行**

---

## ⚠️ 实现困难功能详细分析

以下16项功能需要额外开发工作，详细分析其技术难点和解决方案：

### 🔴 核心功能中的挑战 (2项)

#### **021 多级列表** (可行性: 85%)
**技术难点**:
- Textual的列表支持有限，主要是显示层面
- QTextList的嵌套机制需要复杂的层级管理
- 自动编号和缩进的同步更新

**解决方案**:
```python
class NestedListManager:
    def __init__(self, document: QTextDocument):
        self.document = document
        self.list_stack = []  # 维护嵌套层级栈

    def create_nested_list(self, level: int, list_type: QTextListFormat.Style):
        # 创建嵌套列表的复杂逻辑
        # 需要处理父子关系和自动编号
```

#### **024 分页符/分节符** (可行性: 80%)
**技术难点**:
- Textual主要用于终端显示，无分页概念
- QTextDocument的分页需要自定义实现
- 打印预览和分页显示的同步

**解决方案**:
```python
class PageBreakManager:
    def insert_page_break(self, cursor: QTextCursor):
        # 插入分页符的自定义实现
        frame_format = QTextFrameFormat()
        frame_format.setPageBreakPolicy(QTextFormat.PageBreak_AlwaysBefore)
        cursor.insertFrame(frame_format)
```

### 🟡 重要功能中的挑战 (8项)

#### **038 智能节点链接与自动完成** (可行性: 85%)
**技术难点**:
- Textual无直接的自动完成支持
- 需要实现模糊搜索算法
- 节点数据库的维护和查询优化

**解决方案**:
```python
class SmartNodeCompleter(QCompleter):
    def __init__(self, node_database):
        super().__init__()
        self.node_db = node_database
        self.fuzzy_matcher = FuzzyMatcher()

    def splitPath(self, path):
        # 实现模糊匹配的路径分割
        return self.fuzzy_matcher.match(path, self.node_db.get_all_nodes())
```

#### **043 一键多格式导出** (可行性: 90%)
**技术难点**:
- Textual无格式转换功能
- 需要集成多个第三方转换库
- 样式保持和格式兼容性

**解决方案**:
```python
class MultiFormatExporter:
    def __init__(self):
        self.converters = {
            'pdf': PDFConverter(),
            'epub': EPUBConverter(),
            'docx': DOCXConverter(),
            'html': HTMLConverter()
        }

    def export_to_format(self, document: QTextDocument, format: str):
        # 统一的格式转换接口
```

#### **048 拼写检查** (可行性: 85%)
**技术难点**:
- Textual无拼写检查功能
- 需要集成词典库(如hunspell)
- 实时检查的性能优化

**解决方案**:
```python
class SpellChecker:
    def __init__(self):
        self.dictionary = hunspell.HunSpell('zh_CN.dic', 'zh_CN.aff')
        self.error_format = QTextCharFormat()
        self.error_format.setUnderlineStyle(QTextCharFormat.SpellCheckUnderline)

    def check_document(self, document: QTextDocument):
        # 实时拼写检查实现
```

#### **049 语法检查** (可行性: 80%)
**技术难点**:
- Textual无语法检查功能
- 中文语法规则复杂
- 需要自然语言处理技术

**解决方案**:
```python
class GrammarChecker:
    def __init__(self):
        self.grammar_rules = ChineseGrammarRules()
        self.nlp_processor = NLPProcessor()

    def check_grammar(self, text: str):
        # 基于规则和NLP的语法检查
```

#### **052 思维导图式大纲编辑器** (可行性: 75%)
**技术难点**:
- Textual无图形化思维导图支持
- 需要自定义绘制思维导图界面
- 大纲与正文的双向同步机制复杂

**解决方案**:
```python
class MindMapOutlineEditor(QWidget):
    def __init__(self):
        super().__init__()
        self.scene = QGraphicsScene()
        self.view = QGraphicsView(self.scene)
        self.sync_manager = OutlineTextSyncManager()

    def paintEvent(self, event):
        # 自定义思维导图绘制
```

#### **053 交叉引用** (可行性: 80%)
**技术难点**:
- Textual无引用管理功能
- 需要建立复杂的引用数据库
- 引用关系的可视化和管理

**解决方案**:
```python
class CrossReferenceManager:
    def __init__(self):
        self.reference_db = ReferenceDatabase()
        self.link_tracker = LinkTracker()

    def create_reference(self, source_pos, target_node):
        # 创建交叉引用的实现
```

### 🟢 补充功能中的挑战 (6项)

#### **062 表格编辑** (可行性: 85%)
**技术难点**:
- Textual的DataTable主要用于数据显示
- QTextTable的动态编辑需要复杂的事件处理
- 表格结构变更的撤销重做

**解决方案**:
```python
class AdvancedTableEditor:
    def __init__(self, table: QTextTable):
        self.table = table
        self.edit_history = TableEditHistory()

    def insert_row(self, position: int):
        # 复杂的表格行插入逻辑
```

#### **063 单元格合并/拆分** (可行性: 80%)
**技术难点**:
- Textual无单元格合并概念
- QTextTable的合并算法复杂
- 合并后的内容处理和格式保持

**解决方案**:
```python
class CellMergeManager:
    def merge_cells(self, table: QTextTable, top_row: int, left_col: int,
                   row_span: int, col_span: int):
        # 单元格合并的复杂实现
```

#### **065 表格对齐** (可行性: 85%)
**技术难点**:
- Textual的布局系统与QTextEdit差异较大
- 表格在文档中的对齐需要框架级别的支持

#### **072 分栏布局** (可行性: 80%)
**技术难点**:
- Textual无分栏概念
- QTextDocument的分栏需要复杂的布局计算
- 内容在栏间的自动流动

**解决方案**:
```python
class ColumnLayoutManager:
    def __init__(self, document: QTextDocument):
        self.document = document
        self.column_count = 1
        self.column_spacing = 10

    def apply_column_layout(self, columns: int):
        # 分栏布局的实现
```

#### **077 标尺显示** (可行性: 85%)
**技术难点**:
- Textual无标尺概念
- 需要自定义绘制标尺控件
- 标尺与编辑器的同步滚动

**解决方案**:
```python
class RulerWidget(QWidget):
    def __init__(self, text_edit: QTextEdit):
        super().__init__()
        self.text_edit = text_edit
        self.unit = 'cm'  # 或 'inch', 'px'

    def paintEvent(self, event):
        # 自定义标尺绘制
```

---

## 🚀 推荐实施策略

### **第一阶段 (4-6周)**: 🔴核心功能
- 优先实现30项完全可行的功能
- 对2项挑战功能进行技术预研
- 建立基础架构和核心编辑能力

### **第二阶段 (6-8周)**: 🟡重要功能
- 实现20项完全可行的功能
- 攻克8项挑战功能，重点是智能节点链接和多格式导出
- 完善用户体验和界面交互

### **第三阶段 (4-6周)**: 🟢补充功能
- 实现12项完全可行的功能
- 解决6项挑战功能，重点是表格编辑和分栏布局
- 优化性能和稳定性

### **技术风险控制**:
1. **并行开发**: 简单功能和复杂功能并行推进
2. **原型验证**: 对困难功能先做技术原型
3. **渐进实现**: 复杂功能分阶段实现，先基础后高级
4. **备选方案**: 为每个困难功能准备简化的备选实现

**最终结论**: 基于Textual的实现思路移植到QTextEdit来实现StoryWeaver富文本编辑器的完整78项功能是**高度可行**的，预计总开发周期14-20周，可以创造出功能强大、用户体验优秀的专业级富文本编辑器。
